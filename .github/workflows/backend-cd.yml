name: CD - Deploy Backend
on:
   workflow_dispatch:
   push:
    branches:
      - main
    paths:
      - backend/**
  
jobs:
 deploy:
    name: build backend
    runs-on: ubuntu-18.04
    services:
      postgres:
        image: postgres:15.2
        env:
          POSTGRES_USER: buseni
          POSTGRES_PASSWORD: password
          POSTGRES_DB: buseni
        ports:
          - 5332:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    defaults:
      run:
        working-directory: ./backend
    steps:
    - name: Checkout
      uses: actions/checkout@v3.4.0

    - name: Setup Java JDK
      uses: actions/setup-java@v3.10.0
      with:
       java-version: 17
       cache: maven
       distribution: temurin
    - name : Login to docker hub
      uses: docker/login_action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}
    - name : Set build number
      id : build-number
      run: echo "BUILD_NUMBER=$(date '+%d.%m.%Y.%H.%M.%S')" >> $GITHUB_OUTPUT

    - name: Build Package and Push with Maven
      run: mvn -ntp -B verify
   
