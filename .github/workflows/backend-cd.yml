name: CD - Deploy Backend
on:
   workflow_dispatch:
   push:
    branches:
      - main
    paths:
      - backend/**
  
jobs:
 deploy:
    name: build backend
    runs-on: ubuntu-18.04
    services:
      postgres:
        image: postgres:15.2
        env:
          POSTGRES_USER: buseni
          POSTGRES_PASSWORD: password
          POSTGRES_DB: buseni
        ports:
          - 5332:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    defaults:
      run:
        working-directory: ./backend
    steps:
    - name: Checkout
      uses: actions/checkout@v3.4.0

    - name: Setup Java JDK
      uses: actions/setup-java@v3.10.0
      with:
       java-version: '17'
       cache: 'maven'
       distribution: 'temurin'

    - name : Login to docker hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}
    - name : Set build number
      id : build-number
      run: echo "BUILD_NUMBER=$(date '+%d.%m.%Y.%H.%M.%S')" >> $GITHUB_OUTPUT

    - name: Build Package and Push with Maven
      run: mvn -ntp -B verify  -Ddocker.image.tag=${{steps.build-number.outputs.BUILD_NUMBER}} jib:build

    - name: Update Dockerrun.aws.json api image tag with new build number
      run: |
        echo "Dockerrun.aws.json before updating tag"
        cat ../Dockerrun.aws.json
        sed -i -E 's_(amigoscode/amigoscode-api:)([^"]*)_\1'${{steps.build-number.outputs.BUILD_NUMBER}}'_' ../Dockerrun.aws.json
        echo "Dockerrun.aws.json after updating tag"
        cat ../Dockerrun.aws.json

    - name: Deploy to Elastic Beanstalk
      uses: einaregilsson/beanstalk-deploy@v21
      with:
        aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        application_name: ${{ vars.EB_APPLICATION_NAME }}
        environment_name: ${{ vars.EB_ENVIRONMENT_NAME }}
        version_label: ${{ steps.build-number.outputs.BUILD_NUMBER }}
        version_description: ${{ github.SHA }}
        region: ${{ vars.EB_REGION }}
        deployment_package: backend/Dockerrun.aws.json

    - name: Commit and push Dockerrun.aws.json
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        git add ../Dockerrun.aws.json
        git commit -m "Update Dockerrun.aws.json docker image with new tag ${{ steps.build-number.outputs.BUILD_NUMBER }}"
        git push

   
